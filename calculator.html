<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prime Facility Services Group - Calculadora de Limpieza</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {--brand-blue: #03143A; --brand-red: #C70532; --light-blue: #EBF2FA; --border-color: #e0e0e0; --success-green: #27ae60; --warning-orange: #f39c12; --danger-red: #e74c3c; --optimize-color: #1abc9c;}
        * {box-sizing: border-box; margin: 0; padding: 0; font-family: 'Montserrat', sans-serif;}
        body {background-color: #f5f5f5; color: #333; line-height: 1.6;}
        .container {max-width: 1100px; margin: 0 auto; background-color: white; box-shadow: 0 4px 15px rgba(0,0,0,0.1);}
        .calculator-header {background-color: var(--brand-blue); color: white; padding: 20px 40px; display: flex; justify-content: space-between; align-items: center;}
        .calculator-title {font-size: 24px; font-weight: bold;}
        .calculator-subtitle {font-size: 14px; opacity: 0.9; margin-top: 5px;}
        .calculator-content {padding: 20px;}
        .calculator-grid {display: grid; grid-template-columns: 1fr 1fr; gap: 20px;}
        .top-row {display: flex; gap: 20px; margin-bottom: 20px;}
        .nav-tabs {display: flex; background-color: var(--brand-blue); border-top: 1px solid rgba(255,255,255,0.2); flex-wrap: wrap;}
        .nav-tab {padding: 12px 20px; color: white !important; text-decoration: none; display: flex; align-items: center; font-size: 14px; cursor: pointer;}
        .nav-tab i {margin-right: 8px; color: white !important;}
        .nav-tab.active {background-color: var(--brand-red);}
        .nav-tab:hover:not(.active) {background-color: rgba(255,255,255,0.1);}
        .nav-tab-reset {margin-left: auto;}
        .section-card {background-color: var(--light-blue); border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px;}
        .section-header {background-color: var(--light-blue); padding: 15px 20px; display: flex; align-items: center; border-left: 4px solid var(--brand-blue);}
        .section-header i {margin-right: 10px; color: var(--brand-blue); font-size: 18px;}
        .section-header h3 {font-size: 16px; color: var(--brand-blue); font-weight: 600; flex-grow: 1;}
        .toggle-section {background: none; border: none; color: var(--brand-blue); cursor: pointer; font-size: 16px;}
        .section-content {padding: 20px; background-color: white; border: 1px solid #e8e8e8; border-top: none;}
        .hidden-section {display: none;}
        .input-row {display: flex; flex-wrap: wrap; margin: 0 -10px;}
        .input-col {flex: 1; min-width: 150px; padding: 0 10px; margin-bottom: 15px;}
        .input-field {margin-bottom: 15px;}
        .input-field label {display: block; font-size: 14px; margin-bottom: 5px; font-weight: 500; color: #555;}
        .input-field input, .input-field select {width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 14px;}
        .input-field input:focus, .input-field select:focus {outline: none; border-color: var(--brand-blue); box-shadow: 0 0 0 2px rgba(3,20,58,0.1);}
        .invalid-input {border-color: var(--brand-red) !important;}
        .error-message {color: var(--brand-red); font-size: 12px; margin-top: 3px; display: none;}
        .help-text {font-size: 12px; color: #777; margin-top: 3px;}
        .form-group-title {font-size: 16px; margin-bottom: 15px; color: var(--brand-blue); font-weight: 600; display: flex; justify-content: space-between; align-items: center;}
        .compact-options-grid {display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;}
        .checkbox-field {display: flex; align-items: center; margin-bottom: 15px;}
        .checkbox-field input {margin-right: 10px; width: auto;}
        .toggle-option {display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;}
        .toggle-option label {flex-grow: 1;}
        .toggle-option .toggle-switch {margin-left: 10px;}
        .toggle-switch {position: relative; display: inline-block; width: 42px; height: 20px; margin: 0 8px;}
        .toggle-switch input {opacity: 0; width: 0; height: 0;}
        .toggle-slider {position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px;}
        .toggle-slider:before {position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%;}
        input:checked + .toggle-slider {background-color: var(--brand-blue);}
        input:checked + .toggle-slider:before {transform: translateX(22px);}
        .slider-container {margin: 15px 0;}
        .slider-container label {display: block; font-size: 14px; margin-bottom: 5px; color: #555;}
        .slider-wrapper {display: flex; align-items: center;}
        .slider {-webkit-appearance: none; width: 100%; height: 8px; border-radius: 4px; background: #ddd; outline: none; flex-grow: 1; margin-right: 10px;}
        .slider::-webkit-slider-thumb {-webkit-appearance: none; width: 18px; height: 18px; border-radius: 50%; background: var(--brand-blue); cursor: pointer;}
        .slider::-moz-range-thumb {width: 18px; height: 18px; border-radius: 50%; background: var(--brand-blue); cursor: pointer;}
        .slider-value {min-width: 50px; padding: 5px; text-align: center; border: 1px solid #ccc; border-radius: 4px; font-weight: bold;}
        .slider-hint {display: flex; justify-content: space-between; font-size: 12px; color: #777; margin-top: 5px;}
        .advanced-options {background-color: #f9f9f9; border: 1px solid #eee; border-radius: 8px; padding: 15px; margin-top: 15px;}
        .advanced-options-title {font-size: 15px; color: #555; margin-bottom: 15px; display: flex; align-items: center; justify-content: space-between; cursor: pointer;}
        .advanced-options-content {display: none;}
        .advanced-options-content.visible {display: block;}
        .option-group {margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #eee;}
        .option-group:last-child {border-bottom: none; margin-bottom: 0; padding-bottom: 0;}
        .option-title {font-size: 14px; font-weight: 600; margin-bottom: 10px; color: #555;}
        .percentage-option {display: flex; align-items: center; margin-bottom: 8px;}
        .percentage-option label {flex-grow: 1; font-size: 13px;}
        .percentage-option input[type="number"] {width: 70px; padding: 5px; border: 1px solid #ccc; border-radius: 4px; text-align: right;}
        .options-divider {border-top: 1px dashed #ccc; margin: 15px 0; padding-top: 15px;}
        .profit-optimization-panel {background-color: #f5f9ff; border: 1px solid #d5e8ff; border-radius: 8px; padding: 15px; margin: 15px 0;}
        .profit-optimization-title {font-weight: 600; color: var(--brand-blue); display: flex; align-items: center; margin-bottom: 10px;}
        .profit-options {display: flex; flex-direction: column; gap: 12px;}
        .profit-option {display: flex; align-items: center; padding: 8px 12px; border-radius: 6px; background-color: rgba(255,255,255,0.7);}
        .profit-option.active {background-color: rgba(26,188,156,0.1); border-left: 3px solid var(--optimize-color);}
        .profit-option.disabled {opacity: 0.6; cursor: not-allowed;}
        .profit-option-content {flex-grow: 1;}
        .profit-option-title {font-weight: 500; margin-bottom: 3px;}
        .profit-option-desc {font-size: 12px; color: #666;}
        .profit-option-control {margin-left: 10px;}
        .profit-option-control input[type="number"] {width: 80px; text-align: center;}
        .result-section, .profit-section {background-color: var(--light-blue); padding: 20px; border-radius: 8px; margin-top: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);}
        .profit-section {background-color: #f9f9f9;}
        .profit-section h4 {font-size: 16px; color: var(--brand-blue); margin-bottom: 15px; font-weight: 600;}
        .result-row, .profit-row {display: grid; grid-template-columns: 1fr 1fr; padding: 8px 0; border-bottom: 1px solid #e0e0e0;}
        .result-row .label, .profit-row .label {font-weight: 500;}
        .result-row .value, .profit-row .value {text-align: right; font-weight: 600;}
        .result-row .details {grid-column: span 2; font-size: 13px; color: #666; margin-top: 5px;}
        .cost-detail-row {font-size: 13px; color: #666;}
        .profit-row.total {font-weight: 600; border-top: 1px solid var(--border-color); margin-top: 10px; padding-top: 10px; border-bottom: none;}
        .result-total {display: grid; grid-template-columns: 1fr 1fr; padding: 15px 0; margin-top: 10px; border-top: 2px solid var(--brand-blue); font-size: 18px;}
        .result-total .label {font-weight: 700; color: var(--brand-blue);}
        .result-total .value {text-align: right; font-weight: 700; color: var(--brand-red);}
        .total-cost-percentage {background-color: #f0f7ff; padding: 15px; border-radius: 8px; margin-top: 15px; border: 1px dashed #ccc;}
        .total-cost-percentage h5 {color: var(--brand-blue); margin-bottom: 10px; font-size: 14px;}
        .percentage-bar {height: 20px; background-color: #e0e0e0; border-radius: 10px; overflow: hidden; margin-bottom: 10px; position: relative;}
        .percentage-fill {height: 100%; background-color: var(--brand-blue); width: 0%; transition: width 0.3s ease;}
        .percentage-text-overlay {position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; justify-content: center; align-items: center; color: white; font-weight: bold; font-size: 12px; text-shadow: 0 0 2px rgba(0,0,0,0.5);}
        .percentage-text {display: flex; justify-content: space-between; font-size: 13px;}
        .subcontract-details {display: none; margin-top: 15px;}
        .subcontract-details.visible {display: block;}
        .extra-benefit {background-color: #efffef; padding: 5px 8px; border-radius: 4px; margin-top: 5px; border: 1px solid #27ae60;}
        .text-muted {color: #999;}
        .text-crossed {text-decoration: line-through; color: #999;}
        .text-highlight {color: #27ae60; font-weight: 600;}
        .high-profit::after {content: "✓"; color: var(--success-green); font-weight: bold; font-size: 16px; margin-left: 8px;}
        .low-profit::after {content: "⚠"; color: var(--danger-red); font-weight: bold; font-size: 16px; margin-left: 8px;}
        .optimization-active {background-color: #f1fff9; border-left: 3px solid var(--optimize-color); padding-left: 15px;}
        .optimization-badge {display: inline-block; background-color: var(--optimize-color); color: white; font-size: 12px; padding: 2px 8px; border-radius: 4px; margin-left: 8px; position: relative; z-index: 1;}
        .target-achieved {background-color: #d5f5e3; border-left: 3px solid var(--success-green); padding: 5px 10px; border-radius: 0 4px 4px 0; margin-left: -10px; font-weight: 500;}
        .target-achieved i {color: var(--success-green); margin-right: 5px;}
        .location-alert {font-weight: 600; color: var(--warning-orange); margin-left: 5px;}
        .expandable {cursor: pointer;}
        .expandable i {transition: transform 0.3s ease;}
        .insurance-costs {background-color: #f5f5ff; border: 1px solid #e0e0ff; border-radius: 8px; padding: 15px; margin-top: 15px;}
        .insurance-title {font-weight: 600; color: var(--brand-blue); margin-bottom: 10px;}
        .insurance-info {font-size: 12px; color: #666; margin-bottom: 10px; font-style: italic;}
        .btn {padding: 10px 20px; border: none; border-radius: 4px; font-weight: 600; cursor: pointer; transition: all 0.2s ease;}
        .btn-primary {background-color: var(--brand-blue); color: white;}
        .btn-primary:hover {background-color: #051d4a;}
        .action-buttons {display: flex; flex-wrap: wrap; gap: 10px; margin-top: 20px;}
        .action-btn {display: inline-flex; align-items: center; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; transition: all 0.2s ease;}
        .action-btn i {margin-right: 8px;}
        .print-btn {background-color: #444; color: white;}
        .print-btn:hover {background-color: #333;}
        .screenshot-btn {background-color: #2980b9; color: white;}
        .screenshot-btn:hover {background-color: #2573a7;}
        .tooltip {position: relative; display: inline-block; margin-left: 5px; color: #777;}
        .tooltip .tooltip-text {visibility: hidden; width: 220px; background-color: #333; color: #fff; text-align: center; border-radius: 6px; padding: 8px 12px; position: absolute; z-index: 1; bottom: 125%; left: 50%; margin-left: -110px; opacity: 0; transition: opacity 0.3s; font-size: 13px; font-weight: normal; box-shadow: 0 3px 8px rgba(0,0,0,0.2);}
        .tooltip:hover .tooltip-text {visibility: visible; opacity: 1;}
        .modal {display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);}
        .modal-content {position: relative; background-color: white; margin: 10% auto; padding: 20px; border-radius: 8px; width: 80%; max-width: 800px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);}
        .close-modal {position: absolute; right: 15px; top: 10px; font-size: 24px; cursor: pointer; color: #777;}
        .download-link {display: inline-block; margin-top: 15px; padding: 10px 20px; background-color: var(--brand-blue); color: white; text-decoration: none; border-radius: 4px; font-weight: 600;}
        .sr-only {position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); border: 0;}
        .calculator-footer {text-align: center; padding: 20px; border-top: 1px solid #f0f0f0; color: #777; font-size: 13px;}
        @media (max-width: 768px) {
            .calculator-grid {grid-template-columns: 1fr;}
            .nav-tabs {flex-direction: column;}
            .nav-tab-reset {margin-left: 0;}
            .calculator-header {flex-direction: column; text-align: center;}
            .calculator-icon {margin-top: 10px;}
            .input-row {flex-direction: column;}
            .input-col {padding: 0; margin-bottom: 15px;}
            input[type="number"], input[type="checkbox"], select, button {min-height: 48px; font-size: 16px;}
            .result-row, .profit-row {display: flex; flex-direction: column;}
            .result-row .value, .profit-row .value {text-align: left; margin-top: 5px;}
            .slider-container {padding: 0 10px;}
            .compact-options-grid {grid-template-columns: 1fr;}
            .top-row {flex-direction: column;}
            #summaryContent > div {flex-direction: column;}
        }
        @media print {
            body {background-color: white !important; margin: 0; padding: 0;}
            .container {width: 100% !important; max-width: 100% !important; margin: 0 !important; padding: 0 !important; box-shadow: none !important; background: white !important;}
            .calculator-header, .nav-tabs, .input-column, #kitchenSection, .calculator-footer, .action-buttons, .advanced-options, .toggle-section, #configContent {display: none !important;}
            .results-column {width: 100% !important; margin: 0 !important; padding: 0 !important;}
            .calculator-content {padding: 0 !important;}
            .calculator-grid {display: block !important;}
            .section-card {page-break-inside: avoid !important; box-shadow: none !important; margin: 0 !important; border: none !important;}
            .section-header {background-color: var(--brand-blue) !important; color: white !important; padding: 15px 20px !important; margin-bottom: 15px !important; border-left: none !important;}
            .section-header::before {content: "Prime Facility Services Group"; font-size: 18px; font-weight: bold; display: block; margin-bottom: 5px;}
            .result-section, .profit-section {padding: 15px !important; font-size: 11pt !important; margin-top: 0 !important; border-radius: 0 !important;}
            .result-row, .profit-row {padding: 6px 0 !important;}
            .hidden-section {display: block !important;}
            .profit-section::after {content: "Kitchen Cleaning Quote - Generated: " attr(data-print-date); display: block; margin-top: 30px; text-align: center; font-size: 9pt; color: #777;}
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="calculator-header">
            <div>
                <h1 class="calculator-title">Kitchen Cleaning Calculator</h1>
                <p class="calculator-subtitle">Optimize your professional kitchen cleaning quotes</p>
            </div>
            <div class="calculator-icon">
                <img src="https://primefacilityservicesgroup.com/wp-content/uploads/2024/02/Logo-Prime-Facility-White-No-Background-1.png" alt="Prime Facility Services Group Logo" style="height:60px;width:auto;">
            </div>
        </div>
        <div class="nav-tabs" role="tablist">
            <a id="quotationTab" class="nav-tab active" role="tab" aria-selected="true" aria-controls="quotationContent"><i class="fas fa-home"></i> Quick Quote</a>
            <a id="configTab" class="nav-tab" role="tab" aria-selected="false" aria-controls="configContent"><i class="fas fa-cog"></i> Configuration</a>
            <a id="breakdownTab" class="nav-tab" role="tab" aria-selected="false" aria-controls="quotationContent"><i class="fas fa-receipt"></i> Breakdown</a>
            <a id="resetBtn" class="nav-tab nav-tab-reset" role="button"><i class="fas fa-redo"></i> Reset</a>
        </div>
        <div class="calculator-content" id="quotationContent" role="tabpanel" aria-labelledby="quotationTab">
            <div class="top-row">
                <div class="section-card" id="basicInputsSection" style="flex:1;">
                    <div class="section-header">
                        <i class="fas fa-users" aria-hidden="true"></i>
                        <h3>Staff & Time</h3>
                        <button class="toggle-section" data-target="basicInputsContent"><i class="fas fa-chevron-up"></i></button>
                    </div>
                    <div class="section-content" id="basicInputsContent">
                        <div class="input-row">
                            <div class="input-col">
                                <div class="input-field">
                                    <label for="workers">Workers</label>
                                    <input type="number" id="workers" min="0" value="2" required>
                                    <p class="error-message" id="workersError" role="alert">Min: 0 workers</p>
                                </div>
                            </div>
                            <div class="input-col">
                                <div class="input-field">
                                    <label for="hours">Hours/Day</label>
                                    <input type="number" id="hours" min="1" value="4" required>
                                    <p class="error-message" id="hoursError" role="alert">Min: 1 hour</p>
                                </div>
                            </div>
                            <div class="input-col">
                                <div class="input-field">
                                    <label for="days">Days</label>
                                    <input type="number" id="days" min="1" value="1" required>
                                    <p class="error-message" id="daysError" role="alert">Min: 1 day</p>
                                </div>
                            </div>
                        </div>
                        <div class="compact-options-grid">
                            <div class="input-field">
                                <label for="materials">Materials ($/day)</label>
                                <input type="number" id="materials" min="0" value="50" required>
                                <p class="error-message" id="materialsError" role="alert">Please enter a valid amount</p>
                            </div>
                            <div class="input-field">
                                <label for="equipment">Equipment ($/day)</label>
                                <input type="number" id="equipment" min="0" value="40" required>
                                <p class="error-message" id="equipmentError" role="alert">Please enter a valid amount</p>
                            </div>
                        </div>
                        <div class="checkbox-field">
                            <input type="checkbox" id="outsideHouston">
                            <label for="outsideHouston"><strong>Outside Houston</strong> <span class="location-alert">(Different transport cost)</span></label>
                        </div>
                        <div class="checkbox-field">
                            <input type="checkbox" id="isHoliday">
                            <label for="isHoliday">Holiday Service (+25%)</label>
                        </div>
                        <div class="options-divider">
                            <div class="checkbox-field">
                                <input type="checkbox" id="useSubcontractor">
                                <label for="useSubcontractor"><strong>Use Subcontractor</strong> (Calculate profit when outsourcing the service)</label>
                            </div>
                            <div id="subcontractorDetails" class="subcontract-details">
                                <div class="input-field">
                                    <label for="subcontractorCost">Subcontractor Cost ($)</label>
                                    <input type="number" id="subcontractorCost" min="0" value="0" required>
                                    <p class="error-message" id="subcontractorCostError" role="alert">Please enter a valid cost amount</p>
                                    <div class="help-text">Total amount charged by the subcontractor for this service</div>
                                </div>
                            </div>
                        </div>
                        <div class="insurance-costs">
                            <div class="insurance-title">
                                <i class="fas fa-shield-alt" aria-hidden="true"></i> Insurance Costs
                            </div>
                            <div class="insurance-info">
                                These mandatory insurance costs are automatically calculated and included in the grand total.
                            </div>
                            <div class="checkbox-field">
                                <input type="checkbox" id="includeInsurance" checked>
                                <label for="includeInsurance"><strong>Include Insurance Costs</strong></label>
                            </div>
                        </div>
                        <div class="advanced-options">
                            <div class="advanced-options-title" id="advancedOptionsToggle">
                                <span><i class="fas fa-sliders-h"></i> Advanced Options</span>
                                <i class="fas fa-chevron-down"></i>
                            </div>
                            <div class="advanced-options-content" id="advancedOptionsContent">
                                <div class="profit-optimization-panel">
                                    <div class="profit-optimization-title">
                                        Profit & Pricing Strategy
                                    </div>
                                    <div class="profit-options">
                                        <div class="profit-option" id="optimizeCostOption">
                                            <div class="profit-option-content">
                                                <div class="profit-option-title">Optimize Costs to 62%</div>
                                                <div class="profit-option-desc">Automatically adjusts markup to maintain ideal cost ratio</div>
                                            </div>
                                            <div class="profit-option-control">
                                                <label class="toggle-switch">
                                                    <input type="checkbox" id="enableAutoCostOptimization">
                                                    <span class="toggle-slider"></span>
                                                </label>
                                            </div>
                                        </div>
                                        <div class="profit-option" id="customMarkupOption">
                                            <div class="profit-option-content">
                                                <div class="profit-option-title">Custom Markup Percentage</div>
                                                <div class="profit-option-desc">Manually set your desired markup percentage</div>
                                            </div>
                                            <div class="profit-option-control">
                                                <label class="toggle-switch">
                                                    <input type="checkbox" id="useCustomMarkup">
                                                    <span class="toggle-slider"></span>
                                                </label>
                                            </div>
                                        </div>
                                        <div id="markupSliderContainer" style="display:none;margin:5px 0 5px 30px;">
                                            <div class="slider-wrapper">
                                                <input type="range" min="20" max="500" value="120" class="slider" id="markupSlider">
                                                <input type="number" min="20" value="120" class="slider-value" id="markupInput">
                                            </div>
                                            <div class="slider-hint">
                                                <span>Low</span>
                                                <span>High</span>
                                            </div>
                                        </div>
                                        <div class="profit-option" id="residualOption">
                                            <div class="profit-option-content">
                                                <div class="profit-option-title">Residual Percentage</div>
                                                <div class="profit-option-desc">Add percentage to subtotal before markup is applied</div>
                                            </div>
                                            <div class="profit-option-control">
                                                <label class="toggle-switch">
                                                    <input type="checkbox" id="enableResidualPercentage">
                                                    <span class="toggle-slider"></span>
                                                </label>
                                            </div>
                                        </div>
                                        <div id="residualPercentageContainer" style="display:none;margin:5px 0 5px 30px;">
                                            <div class="percentage-option">
                                                <label for="residualPercentageValue">Residual percentage value</label>
                                                <input type="number" id="residualPercentageValue" min="0" max="100" step="0.1" value="10">
                                            </div>
                                        </div>
                                        <div class="profit-option">
                                            <div class="profit-option-content">
                                                <div class="profit-option-title">Sales Commission</div>
                                                <div class="profit-option-desc">Percentage of net profit for sales commission</div>
                                            </div>
                                            <div class="profit-option-control">
                                                <input type="number" id="commissionPercentage" min="0" max="100" step="0.1" value="20">
                                            </div>
                                        </div>
                                        <div class="profit-option" id="splitCommissionOption">
                                            <div class="profit-option-content">
                                                <div class="profit-option-title">Split Commission</div>
                                                <div class="profit-option-desc">Divide commission between multiple people</div>
                                            </div>
                                            <div class="profit-option-control">
                                                <label class="toggle-switch">
                                                    <input type="checkbox" id="enableCommissionSplit">
                                                    <span class="toggle-slider"></span>
                                                </label>
                                            </div>
                                        </div>
                                        <div id="splitCommissionContainer" style="display:none;margin:5px 0 5px 30px;">
                                            <div class="option-title" style="font-size:13px;margin-bottom:10px;">Commission Split Percentages</div>
                                            <div id="commissionSplitsWrapper">
                                                <div class="percentage-option" style="margin-bottom:8px;">
                                                    <label for="commissionSplit1">Commission 1</label>
                                                    <input type="number" id="commissionSplit1" min="0" max="100" step="0.1" value="10" class="commission-split-input">
                                                </div>
                                                <div class="percentage-option" style="margin-bottom:8px;">
                                                    <label for="commissionSplit2">Commission 2</label>
                                                    <input type="number" id="commissionSplit2" min="0" max="100" step="0.1" value="10" class="commission-split-input">
                                                </div>
                                            </div>
                                            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;">
                                                <button id="addCommissionSplitBtn" style="background-color:var(--brand-blue);color:white;border:none;border-radius:4px;padding:5px 10px;font-size:12px;cursor:pointer;">
                                                    <i class="fas fa-plus" style="margin-right:5px;"></i> Add More
                                                </button>
                                                <div style="font-size:13px;font-weight:500;">
                                                    Total: <span id="totalCommissionSplit">20%</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="option-group">
                                    <div class="option-title">Cost Components</div>
                                    <div class="compact-options-grid">
                                        <div class="toggle-option">
                                            <label for="includeTransport">Include Transportation</label>
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="includeTransport" checked>
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                        <div class="toggle-option">
                                            <label for="includeMaterials">Include Materials</label>
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="includeMaterials" checked>
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                        <div class="toggle-option">
                                            <label for="includeEquipment">Include Equipment</label>
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="includeEquipment" checked>
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                        <div class="toggle-option">
                                            <label for="enableRounding">Enable Rounding</label>
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="enableRounding" checked>
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="option-group">
                                    <div class="option-title">Operational Percentages</div>
                                    <div class="compact-options-grid">
                                        <div class="percentage-option">
                                            <label for="regularSuppliesPercentage">Regular Supplies</label>
                                            <input type="number" id="regularSuppliesPercentage" min="0" max="100" step="0.1" value="6">
                                        </div>
                                        <div class="percentage-option">
                                            <label for="additionalEquipmentPercentage">Additional Equipment</label>
                                            <input type="number" id="additionalEquipmentPercentage" min="0" max="100" step="0.1" value="2.75">
                                        </div>
                                        <div class="percentage-option">
                                            <label for="uniformSafetyPercentage">Uniform/Safety/Misc</label>
                                            <input type="number" id="uniformSafetyPercentage" min="0" max="100" step="0.1" value="2.5">
                                        </div>
                                        <div class="percentage-option">
                                            <label for="communicationsPercentage">Communications</label>
                                            <input type="number" id="communicationsPercentage" min="0" max="100" step="0.1" value="1">
                                        </div>
                                        <div class="percentage-option">
                                            <label for="overheadPercentage">Overhead</label>
                                            <input type="number" id="overheadPercentage" min="0" max="100" step="0.1" value="5">
                                        </div>
                                    </div>
                                </div>
                                <div class="option-group">
                                    <div class="option-title">Initial Fee</div>
                                    <div class="toggle-option">
                                        <label for="enableInitialFee">Add initial fee charge</label>
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="enableInitialFee">
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                    <div id="initialFeeContainer" style="display:none;margin-top:10px;">
                                        <div class="input-field">
                                            <label for="initialFeeValue">Initial Fee Amount ($)</label>
                                            <input type="number" id="initialFeeValue" min="0" value="150">
                                        </div>
                                        <div class="help-text">One-time fee added at the beginning of the contract</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="section-card" id="kitchenSection" style="flex:1;">
                    <div class="section-header">
                        <i class="fas fa-utensils" aria-hidden="true"></i>
                        <h3>Kitchen Details</h3>
                        <button class="toggle-section" data-target="kitchenContent"><i class="fas fa-chevron-up"></i></button>
                    </div>
                    <div class="section-content" id="kitchenContent">
                        <div class="form-group-title">Hood Cleaning</div>
                        <div class="input-row">
                            <div class="input-col">
                                <div class="input-field">
                                    <label for="largeHoods">Large Hoods</label>
                                    <input type="number" id="largeHoods" min="0" value="0" required>
                                    <p class="error-message" id="largeHoodsError" role="alert">Please enter a valid number</p>
                                    <div class="help-text" id="largeHoodPrice">$650 each</div>
                                </div>
                            </div>
                            <div class="input-col">
                                <div class="input-field">
                                    <label for="smallHoods">Small Hoods</label>
                                    <input type="number" id="smallHoods" min="0" value="0" required>
                                    <p class="error-message" id="smallHoodsError" role="alert">Please enter a valid number</p>
                                    <div class="help-text" id="smallHoodPrice">$550 each</div>
                                </div>
                            </div>
                        </div>
                        <div class="input-field">
                            <label for="hoodFrequency">Cleaning Frequency</label>
                            <input type="number" id="hoodFrequency" min="1" value="1" required>
                            <p class="error-message" id="hoodFrequencyError" role="alert">Min: 1 cleaning</p>
                            <div class="help-text">Number of times during contract</div>
                        </div>
                        <div class="form-group-title" style="margin-top:15px;">Hood Costs Breakdown</div>
                        <div class="input-row">
                            <div class="input-col">
                                <div class="input-field">
                                    <label for="hoodLaborCostPerc">Labor Cost Percentage</label>
                                    <input type="number" id="hoodLaborCostPerc" min="0" max="100" value="38" required>
                                    <div class="help-text">Percentage of hood price that represents labor costs</div>
                                </div>
                            </div>
                            <div class="input-col">
                                <div class="input-field">
                                    <label for="hoodMaterialCostPerc">Material Cost Percentage</label>
                                    <input type="number" id="hoodMaterialCostPerc" min="0" max="100" value="12" required>
                                    <div class="help-text">Percentage of hood price that represents material costs</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="section-card">
                <div class="section-header">
                    <i class="fas fa-file-invoice-dollar" aria-hidden="true"></i>
                    <h3>Quote Summary</h3>
                    <button class="toggle-section" data-target="summaryContent"><i class="fas fa-chevron-up"></i></button>
                </div>
                <div class="section-content" id="summaryContent">
                    <div style="display:flex;gap:20px;">
                        <div style="flex:1;">
                            <div class="result-section">
                                <div class="result-row" id="laborRow">
                                    <div class="label">Labor Cost:</div>
                                    <div class="value" id="laborCost">$0.00</div>
                                    <div class="details" id="laborDetails"></div>
                                </div>
                                <div class="result-row" id="laborTaxRow">
                                    <div class="label">Labor Taxes (17%):</div>
                                    <div class="value" id="laborTax">$0.00</div>
                                    <div class="details" id="laborTaxDetails">Employment taxes and benefits</div>
                                </div>
                                <div class="result-row" id="workCompRow">
                                    <div class="label">Worker's Compensation:</div>
                                    <div class="value" id="workCompCost">$0.00</div>
                                    <div class="details" id="workCompDetails">$1.88 per $100 of labor cost</div>
                                </div>
                                <div class="result-row" id="transportRow">
                                    <div class="label">Transport Cost:</div>
                                    <div class="value" id="transportCost">$0.00</div>
                                    <div class="details" id="transportDetails"></div>
                                </div>
                                <div class="result-row" id="materialsRow">
                                    <div class="label">Materials:</div>
                                    <div class="value" id="materialsCost">$0.00</div>
                                    <div class="details" id="materialsDetails"></div>
                                </div>
                                <div class="result-row" id="equipmentRow">
                                    <div class="label">Equipment:</div>
                                    <div class="value" id="equipmentCost">$0.00</div>
                                    <div class="details" id="equipmentDetails"></div>
                                </div>
                                <div class="result-row" id="hoodCleaningRow">
                                    <div class="label">Hood Cleaning:</div>
                                    <div class="value" id="hoodCleaningCost">$0.00</div>
                                    <div class="details" id="hoodCleaningDetails"></div>
                                </div>
                                <div class="result-row" id="subcontractorRow" style="display:none;">
                                    <div class="label">Subcontractor Cost:</div>
                                    <div class="value" id="subcontractorCostDisplay">$0.00</div>
                                    <div class="details">Amount paid to the subcontractor for this service</div>
                                </div>
                                <div class="result-row expandable" id="operationalCostsRow">
                                    <div class="label">Operational Costs <i class="fas fa-chevron-down" style="font-size:12px;margin-left:5px;cursor:pointer;"></i></div>
                                    <div class="value" id="operationalCostsValue">$0.00</div>
                                    <div class="details" id="operationalCostsDetails" style="display:none;">
                                        <div class="cost-detail-row" id="regularSuppliesRow" style="display:flex;justify-content:space-between;margin:5px 0;padding-left:15px;">
                                            <div>Regular Supplies (<span id="regularSuppliesPercDisplay">6</span>%)</div>
                                            <div id="regularSuppliesValue">$0.00</div>
                                        </div>
                                        <div class="cost-detail-row" id="additionalEquipmentRow" style="display:flex;justify-content:space-between;margin:5px 0;padding-left:15px;">
                                            <div>Equipment (<span id="additionalEquipmentPercDisplay">2.75</span>%)</div>
                                            <div id="additionalEquipmentValue">$0.00</div>
                                        </div>
                                        <div class="cost-detail-row" id="uniformSafetyRow" style="display:flex;justify-content:space-between;margin:5px 0;padding-left:15px;">
                                            <div>Uniform/Safety/Misc (<span id="uniformSafetyPercDisplay">2.5</span>%)</div>
                                            <div id="uniformSafetyValue">$0.00</div>
                                        </div>
                                        <div class="cost-detail-row" style="display:flex;justify-content:space-between;margin:5px 0;padding-left:15px;">
                                            <div>Communications (<span id="communicationsPercDisplay">1</span>%)</div>
                                            <div id="communicationsValue">$0.00</div>
                                        </div>
                                        <div class="cost-detail-row" style="display:flex;justify-content:space-between;margin:5px 0;padding-left:15px;">
                                            <div>Overhead (<span id="overheadPercDisplay">5</span>%)</div>
                                            <div id="overheadValue">$0.00</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="result-row">
                                    <div class="label">Subtotal:</div>
                                    <div class="value" id="subtotal">$0.00</div>
                                </div>
                                <div class="result-row" id="residualPercentageRow" style="display:none;">
                                    <div class="label">Residual (<span id="residualPercentageDisplay">10</span>%):</div>
                                    <div class="value" id="residualPercentageAmount">$0.00</div>
                                    <div class="details">Residual percentage added to subtotal</div>
                                </div>
                                <div class="result-row" id="markupRow">
                                    <div class="label">Service Markup (<span id="markupPercentage">0</span>%): 
                                        <span class="optimization-badge" id="optimizationBadge" style="display:none;">Optimized</span>
                                    </div>
                                    <div class="value" id="markup">$0.00</div>
                                    <div class="details" id="markupDetails"></div>
                                </div>
                                <div class="result-row" id="holidayRow" style="display:none;">
                                    <div class="label">Holiday Surcharge (25%):</div>
                                    <div class="value" id="holidaySurcharge">$0.00</div>
                                </div>
                            </div>
                        </div>
                        <div style="flex:1;">
                            <div class="result-section">
                                <div class="result-total">
                                    <div class="label">TOTAL PRICE:</div>
                                    <div class="value" id="totalPrice">$0.00</div>
                                </div>
                                <div class="result-row" id="generalLiabilityRow">
                                    <div class="label">General Liability Insurance:</div>
                                    <div class="value" id="generalLiabilityCost">$0.00</div>
                                    <div class="details" id="generalLiabilityDetails">$7.33 per $1,000 of total price</div>
                                </div>
                                <div class="result-row" id="initialFeeRow" style="display:none;">
                                    <div class="label">Initial Fee:</div>
                                    <div class="value" id="initialFeeAmount">$0.00</div>
                                    <div class="details">One-time initial fee for service setup</div>
                                </div>
                                <div class="result-row" id="roundingRow">
                                    <div class="label">Rounding Adjustment:</div>
                                    <div class="value" id="roundingAdjustment">$0.00</div>
                                    <div class="details" id="roundingDetails">Rounding Grand Total up to the next $50</div>
                                </div>
                                <div class="result-total" id="grandTotalRow">
                                    <div class="label">GRAND TOTAL:</div>
                                    <div class="value" id="grandTotal">$0.00</div>
                                </div>
                                <div class="total-cost-percentage">
                                    <h5>Total Cost Percentage 
                                        <span id="targetAchievedBadge" class="target-achieved" style="display:none;">
                                            <i class="fas fa-bullseye"></i> Target 62%
                                        </span>
                                        <span class="tooltip"><i class="fas fa-info-circle" aria-hidden="true"></i>
                                            <span class="tooltip-text">This shows what portion of the total price is consumed by all costs combined. Industry standard is below 65%.</span>
                                        </span>
                                    </h5>
                                    <div class="percentage-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                        <div class="percentage-fill" id="costPercentageFill"></div>
                                        <div class="percentage-text-overlay" id="percentageTextOverlay">0%</div>
                                    </div>
                                    <div class="percentage-text">
                                        <span>Costs: <span id="totalCostPercentage">0%</span></span>
                                        <span>Profit: <span id="totalProfitPercentage">0%</span></span>
                                    </div>
                                </div>
                                <div class="result-row" id="extraBenefitRow" style="display:none;margin-top:15px;">
                                    <div class="label">Extra Benefits:</div>
                                    <div class="value text-highlight" id="extraBenefitValue">$0.00</div>
                                    <div class="details extra-benefit" id="extraBenefitDetails">Ahorro por usar subcontratista en lugar de equipo interno</div>
                                </div>
                                <h4 style="margin-top:15px;">Company Profit Breakdown</h4>
                                <div class="profit-row" id="profitMarkupRow">
                                    <div class="label">Service Markup (<span id="profitMarkupPercentage">0</span>%):</div>
                                    <div class="value" id="profitMarkup">$0.00</div>
                                </div>
                                <div class="profit-row" id="subcontractorSavingRow" style="display:none;">
                                    <div class="label">Subcontractor Savings:</div>
                                    <div class="value" id="subcontractorSaving">$0.00</div>
                                </div>
                                <div class="profit-row">
                                    <div class="label">Net Profit:</div>
                                    <div class="value" id="netProfit">$0.00</div>
                                </div>
                                <div class="profit-row" id="salesCommissionRow">
                                    <div class="label">Sales Commission (<span id="commissionPercentageDisplay">20</span>% of net profit):</div>
                                    <div class="value" id="salesCommission">$0.00</div>
                                </div>
                                <div id="splitCommissionRows" style="display:none;">
                                    <div id="splitCommissionRowsContent">
                                        <div class="profit-row commission-split-row" data-index="1">
                                            <div class="label">Commission 1 (<span class="commission-split-display">10</span>%):</div>
                                            <div class="value commission-split-value">$0.00</div>
                                        </div>
                                        <div class="profit-row commission-split-row" data-index="2">
                                            <div class="label">Commission 2 (<span class="commission-split-display">10</span>%):</div>
                                            <div class="value commission-split-value">$0.00</div>
                                        </div>
                                    </div>
                                    <div class="profit-row" style="border-top:1px dashed #ccc;margin-top:5px;padding-top:5px;">
                                        <div class="label">Total Commission (<span id="totalCommissionSplitDisplay">20</span>%):</div>
                                        <div class="value" id="totalSplitCommission">$0.00</div>
                                    </div>
                                </div>
                                <div class="profit-row total">
                                    <div class="label">Final Company Profit:</div>
                                    <div class="value" id="finalCompanyProfit">$0.00</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="action-buttons" style="margin-top:15px;">
                        <button id="printQuoteBtn" class="action-btn print-btn">
                            <i class="fas fa-print" aria-hidden="true"></i> Print Quote
                        </button>
                        <button id="screenshotBtn" class="action-btn screenshot-btn">
                            <i class="fas fa-camera" aria-hidden="true"></i> Capture Quote
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="calculator-content" id="configContent" style="display:none;" role="tabpanel" aria-labelledby="configTab">
            <div class="section-card">
                <div class="section-header">
                    <i class="fas fa-cog" aria-hidden="true"></i>
                    <h3>System Configuration</h3>
                </div>
                <div class="section-content">
                    <div class="input-row">
                        <div class="input-col">
                            <div class="input-field">
                                <label for="regularPayRate">Regular Worker Pay Rate ($/hr)</label>
                                <input type="number" id="regularPayRate" min="1" value="16" required>
                                <p class="error-message" id="regularPayRateError" role="alert">Min: $1/hr</p>
                            </div>
                        </div>
                        <div class="input-col">
                            <div class="input-field">
                                <label for="supervisorPayRate">Supervisor Pay Rate ($/hr)</label>
                                <input type="number" id="supervisorPayRate" min="1" value="18" required>
                                <p class="error-message" id="supervisorPayRateError" role="alert">Min: $1/hr</p>
                            </div>
                        </div>
                    </div>
                    <div class="option-group">
                        <div class="option-title">Transportation Costs</div>
                        <div class="input-row">
                            <div class="input-col">
                                <div class="input-field">
                                    <label for="transportCostConfig">Houston Transport Cost ($/day)</label>
                                    <input type="number" id="transportCostConfig" min="0" value="150" required>
                                    <p class="error-message" id="transportCostConfigError" role="alert">Please enter a valid amount</p>
                                </div>
                            </div>
                            <div class="input-col">
                                <div class="input-field">
                                    <label for="outsideHoustonTransportConfig">Outside Houston Transport ($/day)</label>
                                    <input type="number" id="outsideHoustonTransportConfig" min="0" value="300" required>
                                    <p class="error-message" id="outsideHoustonTransportConfigError" role="alert">Please enter a valid amount</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="option-group">
                        <div class="option-title">Insurance Rates</div>
                        <div class="input-row">
                            <div class="input-col">
                                <div class="input-field">
                                    <label for="workCompRate">Worker's Comp Rate (per $100 labor)</label>
                                    <input type="number" id="workCompRate" min="0" step="0.01" value="1.88" required>
                                    <p class="error-message" id="workCompRateError" role="alert">Please enter a valid amount</p>
                                </div>
                            </div>
                            <div class="input-col">
                                <div class="input-field">
                                    <label for="glRate">General Liability Rate (per $1,000 total)</label>
                                    <input type="number" id="glRate" min="0" step="0.01" value="7.33" required>
                                    <p class="error-message" id="glRateError" role="alert">Please enter a valid amount</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="option-group">
                        <div class="option-title">Hood Prices Configuration</div>
                        <div class="input-row">
                            <div class="input-col">
                                <div class="input-field">
                                    <label for="largeHoodPrice">Large Hood Price ($)</label>
                                    <input type="number" id="largeHoodPriceConfig" min="1" value="650" required>
                                    <p class="error-message" id="largeHoodPriceError" role="alert">Min: $1</p>
                                </div>
                            </div>
                            <div class="input-col">
                                <div class="input-field">
                                    <label for="smallHoodPrice">Small Hood Price ($)</label>
                                    <input type="number" id="smallHoodPriceConfig" min="1" value="550" required>
                                    <p class="error-message" id="smallHoodPriceError" role="alert">Min: $1</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-primary" id="saveConfigBtn" style="margin-top:20px;">Save Configuration</button>
                </div>
            </div>
        </div>
        <div id="screenshotModal" class="modal">
            <div class="modal-content">
                <span class="close-modal">&times;</span>
                <h2>Quote Screenshot</h2>
                <p>Right-click on the image below and select "Save image as..." to download</p>
                <div id="screenshotContainer"></div>
                <a href="#" id="downloadLink" class="download-link" download="kitchen-quote.png">Download Image</a>
            </div>
        </div>
        <div class="calculator-footer">
            Professional Kitchen Cleaning Calculator v2.3<br>
            Optimize your quotes and maximize the profitability of kitchen cleaning services.<br>
            Designed and developed by <strong>Christian Reyes</strong> for <strong>Prime Facility Services Group</strong>.
        </div>
    </div>
<script>
// Main state object using modern ES6+ structure
const state = {
    // Core Data
    useSubcontractor: false,
    subcontractorCost: 0,
    workers: 2,
    hours: 4,
    days: 1,
    materialsPerDay: 50,
    equipmentPerDay: 40,
    largeHoods: 0,
    smallHoods: 0,
    hoodCleaningFrequency: 1,
    hoodLaborCostPerc: 38,  // Default 38% of hood price is labor cost
    hoodMaterialCostPerc: 12, // Default 12% of hood price is material cost
    isHoliday: false,
    outsideHouston: false,
    includeInsurance: true,
    
    // Configuration
    config: {
        regularPayRate: 16,
        supervisorPayRate: 18,
        transportCostPerDay: 150,
        outsideHoustonTransportCostPerDay: 300,
        largeHoodPrice: 650,
        smallHoodPrice: 550,
        workCompRate: 1.88,
        glRate: 7.33
    },
    
    // Options
    options: {
        includeTransport: true,
        includeMaterials: true,
        includeEquipment: true,
        enableRounding: true,
        roundingMethod: 'up',
        roundingValue: 50,
        useCustomMarkup: false,
        customMarkupPercentage: 120,
        commissionPercentage: 20,
        enableCommissionSplit: false,
        commissionSplits: [10, 10],
        regularSuppliesPercentage: 6,
        additionalEquipmentPercentage: 2.75,
        uniformSafetyPercentage: 2.5,
        communicationsPercentage: 1,
        overheadPercentage: 5,
        enableInitialFee: false,
        initialFeeValue: 150,
        enableResidualPercentage: false,
        residualPercentageValue: 10,
        enableAutoCostOptimization: false
    },
    
    // UI State
    ui: {
        sectionStates: {},
        operationalCostsExpanded: false
    }
};

// ===== Helper Functions =====
const formatCurrency = amount => '$' + amount.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
const roundAmount = (amount, method = 'up', value = 50) => {
    if (!value) return amount;
    switch (method) {
        case 'up': return Math.ceil(amount / value) * value;
        case 'down': return Math.floor(amount / value) * value;
        case 'nearest': default: return Math.round(amount / value) * value;
    }
};
const calculateMarkupPercentage = (days) => {
    if (state.options.useCustomMarkup) return state.options.customMarkupPercentage;
    const baseMarkup = 120;
    if (days === 1) return baseMarkup;
    const minMarkup = 35;
    const daysEffect = Math.min(1, (days - 1) / 29);
    let markup = baseMarkup - (baseMarkup - minMarkup) * daysEffect;
    return Math.round(markup);
};

// ===== DOM Utilities =====
const $ = id => document.getElementById(id);
const setDisplay = (id, show) => {
    const el = $(id);
    if (el) el.style.display = show ? (el.classList.contains('grid') ? 'grid' : 'block') : 'none';
};
const setContent = (id, content) => {
    const el = $(id);
    if (el) el.textContent = content;
};
const setHTML = (id, content) => {
    const el = $(id);
    if (el) el.innerHTML = content;
};
const toggleClass = (id, className, condition) => {
    const el = $(id);
    if (el) el.classList.toggle(className, condition);
};

// ===== Event Handlers =====
function initEventListeners() {
    // Tab navigation
    $('quotationTab').addEventListener('click', () => showContent('quotationContent'));
    $('configTab').addEventListener('click', () => showContent('configContent'));
    $('breakdownTab').addEventListener('click', () => {
        showContent('quotationContent');
        document.querySelector('.results-column')?.scrollIntoView({behavior: 'smooth'});
    });
    $('resetBtn').addEventListener('click', resetCalculator);
    
    // Toggle sections
    document.querySelectorAll('.toggle-section').forEach(button => {
        button.addEventListener('click', function() {
            toggleSection(this.getAttribute('data-target'), this);
        });
    });
    
    // Advanced options toggle
    $('advancedOptionsToggle').addEventListener('click', function() {
        const content = $('advancedOptionsContent');
        const icon = this.querySelector('i.fas');
        content.classList.toggle('visible');
        icon.className = content.classList.contains('visible') ? 'fas fa-chevron-up' : 'fas fa-chevron-down';
    });
    
    // Operational costs toggle
    $('operationalCostsRow').addEventListener('click', function() {
        this.classList.toggle('expanded');
        const icon = this.querySelector('i.fas');
        const details = $('operationalCostsDetails');
        
        if (this.classList.contains('expanded')) {
            details.style.display = 'block';
            icon.className = 'fas fa-chevron-up';
            state.ui.operationalCostsExpanded = true;
        } else {
            details.style.display = 'none';
            icon.className = 'fas fa-chevron-down';
            state.ui.operationalCostsExpanded = false;
        }
    });
    
    // Setup checkbox handlers using event delegation
    document.addEventListener('change', e => {
        const checkboxHandlers = {
            'enableInitialFee': checked => {
                state.options.enableInitialFee = checked;
                setDisplay('initialFeeContainer', checked);
            },
            'enableResidualPercentage': checked => {
                state.options.enableResidualPercentage = checked;
                setDisplay('residualPercentageContainer', checked);
                updateProfitOptionClasses();
            },
            'useCustomMarkup': checked => {
                if (state.options.enableAutoCostOptimization && checked) {
                    $('useCustomMarkup').checked = false;
                    return;
                }
                state.options.useCustomMarkup = checked;
                setDisplay('markupSliderContainer', checked);
                updateProfitOptionClasses();
            },
            'enableAutoCostOptimization': checked => {
                state.options.enableAutoCostOptimization = checked;
                if (checked) {
                    $('useCustomMarkup').checked = false;
                    state.options.useCustomMarkup = false;
                    setDisplay('markupSliderContainer', false);
                }
                updateProfitOptionClasses();
            },
            'includeTransport': checked => state.options.includeTransport = checked,
            'includeMaterials': checked => state.options.includeMaterials = checked,
            'includeEquipment': checked => state.options.includeEquipment = checked,
            'isHoliday': checked => state.isHoliday = checked,
            'outsideHouston': checked => state.outsideHouston = checked,
            'useSubcontractor': checked => {
                state.useSubcontractor = checked;
                $('subcontractorDetails').classList.toggle('visible', checked);
            },
            'enableRounding': checked => state.options.enableRounding = checked,
            'includeInsurance': checked => state.includeInsurance = checked,
            'enableCommissionSplit': checked => {
                state.options.enableCommissionSplit = checked;
                setDisplay('splitCommissionContainer', checked);
                setDisplay('salesCommissionRow', !checked);
                setDisplay('splitCommissionRows', checked);
                updateCommissionSplitDisplay();
            }
        };
        
        if (e.target.type === 'checkbox' && checkboxHandlers[e.target.id]) {
            checkboxHandlers[e.target.id](e.target.checked);
            calculateAll();
        }
    });
    
    // Percentage input handlers
    document.addEventListener('input', e => {
        const percentageInputMap = {
            'regularSuppliesPercentage': 'regularSuppliesPercentage',
            'additionalEquipmentPercentage': 'additionalEquipmentPercentage',
            'uniformSafetyPercentage': 'uniformSafetyPercentage',
            'communicationsPercentage': 'communicationsPercentage',
            'overheadPercentage': 'overheadPercentage',
            'commissionPercentage': 'commissionPercentage',
            'residualPercentageValue': 'residualPercentageValue',
            'hoodLaborCostPerc': 'hoodLaborCostPerc',
            'hoodMaterialCostPerc': 'hoodMaterialCostPerc'
        };
        
        if (percentageInputMap[e.target.id]) {
            const value = parseFloat(e.target.value) || 0;
            
            if (e.target.id === 'residualPercentageValue') {
                state.options.residualPercentageValue = value;
                setContent('residualPercentageDisplay', value);
            } else if (e.target.id === 'commissionPercentage') {
                state.options.commissionPercentage = value;
                setContent('commissionPercentageDisplay', value);
            } else if (e.target.id === 'hoodLaborCostPerc') {
                state.hoodLaborCostPerc = value;
            } else if (e.target.id === 'hoodMaterialCostPerc') {
                state.hoodMaterialCostPerc = value;
            } else {
                state.options[e.target.id] = value;
            }
            
            updatePercentageDisplays();
            calculateAll();
        }
        
        // Handle commission split inputs
        if (e.target.classList.contains('commission-split-input')) {
            const index = parseInt(e.target.id.replace('commissionSplit', '')) - 1;
            if (!isNaN(index) && index >= 0 && index < state.options.commissionSplits.length) {
                state.options.commissionSplits[index] = parseFloat(e.target.value) || 0;
                updateCommissionSplitTotals();
                calculateAll();
            }
        }
        
        // Handle numeric value inputs
        const valueInputMap = {
            'workers': { stateKey: 'workers', min: 0 }, // Changed min to 0 to allow 0 workers
            'hours': { stateKey: 'hours', min: 1 },
            'days': { stateKey: 'days', min: 1 },
            'materials': { stateKey: 'materialsPerDay', min: 0 },
            'equipment': { stateKey: 'equipmentPerDay', min: 0 },
            'largeHoods': { stateKey: 'largeHoods', min: 0 },
            'smallHoods': { stateKey: 'smallHoods', min: 0 },
            'hoodFrequency': { stateKey: 'hoodCleaningFrequency', min: 1 },
            'subcontractorCost': { stateKey: 'subcontractorCost', min: 0 },
            'initialFeeValue': { stateKey: 'options.initialFeeValue', min: 0 },
            'markupInput': { stateKey: 'options.customMarkupPercentage', min: 20 }
        };
        
        if (valueInputMap[e.target.id]) {
            const { stateKey, min } = valueInputMap[e.target.id];
            validateInput(e.target);
            
            // Parse value and enforce minimum
            let value = Math.max(min, parseFloat(e.target.value) || min);
            
            // Special handling for markup input
            if (e.target.id === 'markupInput') {
                e.target.value = value;
                state.options.customMarkupPercentage = value;
                $('markupSlider').value = Math.min(500, value);
                calculateAll();
                return;
            }
            
            // Set state value
            if (stateKey.includes('.')) {
                const [obj, prop] = stateKey.split('.');
                state[obj][prop] = value;
            } else {
                state[stateKey] = value;
            }
            
            // Special validation: enforce at least workers=0 when there are hood cleanings
            if (e.target.id === 'workers' || e.target.id === 'largeHoods' || e.target.id === 'smallHoods') {
                validateWorkersWithHoods();
            }
            
            calculateAll();
        }
    });
    
    // Validate that we have workers or hoods
    function validateWorkersWithHoods() {
        // If there are no workers, there should be at least one hood
        if (state.workers === 0 && state.largeHoods === 0 && state.smallHoods === 0) {
            alert("You must have at least one worker or one hood to clean.");
            state.workers = 1;
            $('workers').value = 1;
        }
    }
    
    // Add commission split button
    $('addCommissionSplitBtn').addEventListener('click', function() {
        state.options.commissionSplits.push(0);
        updateCommissionSplitInputs();
        calculateAll();
    });
    
    // Markup Slider
    $('markupSlider').addEventListener('input', function() {
        const value = parseInt(this.value);
        state.options.customMarkupPercentage = value;
        $('markupInput').value = value;
        calculateAll();
    });
    
    // Save configuration button
    $('saveConfigBtn').addEventListener('click', function() {
        if (!validateAllInputs()) {
            alert('Please fix the errors before saving configuration.');
            return;
        }
        
        // Update configuration values
        state.config.regularPayRate = parseFloat($('regularPayRate').value) || 16;
        state.config.supervisorPayRate = parseFloat($('supervisorPayRate').value) || 18;
        state.config.transportCostPerDay = parseFloat($('transportCostConfig').value) || 150;
        state.config.outsideHoustonTransportCostPerDay = parseFloat($('outsideHoustonTransportConfig').value) || 300;
        state.config.largeHoodPrice = parseFloat($('largeHoodPriceConfig').value) || 650;
        state.config.smallHoodPrice = parseFloat($('smallHoodPriceConfig').value) || 550;
        state.config.workCompRate = parseFloat($('workCompRate').value) || 1.88;
        state.config.glRate = parseFloat($('glRate').value) || 7.33;
        
        // Update UI elements that display configuration values
        updateHoodPriceLabels();
        updateInsuranceDetails();
        
        calculateAll();
        showContent('quotationContent');
        alert('Configuration saved successfully.');
    });
    
    // Print and Screenshot buttons
    $('printQuoteBtn').addEventListener('click', function() {
        document.querySelector('.profit-section').setAttribute('data-print-date', new Date().toLocaleDateString());
        window.print();
    });
    
    $('screenshotBtn').addEventListener('click', captureScreenshot);
    document.querySelector('.close-modal').addEventListener('click', function() {
        $('screenshotModal').style.display = 'none';
    });
    
    // Initialize profit options classes
    updateProfitOptionClasses();
    updatePercentageDisplays();
    updateInsuranceDetails();
    
    // Initialize configuration values
    $('workCompRate').value = state.config.workCompRate;
    $('glRate').value = state.config.glRate;
    $('largeHoodPriceConfig').value = state.config.largeHoodPrice;
    $('smallHoodPriceConfig').value = state.config.smallHoodPrice;
    $('transportCostConfig').value = state.config.transportCostPerDay;
    $('outsideHoustonTransportConfig').value = state.config.outsideHoustonTransportCostPerDay;
}

// ===== Validation Functions =====
function validateInput(input) {
    const errorElement = document.getElementById(input.id + 'Error');
    if (!errorElement) return true;
    
    let isValid = true, errorMsg = '';
    const min = parseFloat(input.getAttribute('min'));
    const value = parseFloat(input.value);
    
    if (input.value === '' || isNaN(value)) {
        isValid = false;
        errorMsg = 'Please enter a valid number';
    } else if (!isNaN(min) && value < min) {
        isValid = false;
        errorMsg = 'Minimum value is ' + min;
    }
    
    input.classList.toggle('invalid-input', !isValid);
    errorElement.style.display = isValid ? 'none' : 'block';
    if (!isValid) errorElement.textContent = errorMsg;
    input.setAttribute('aria-invalid', !isValid);
    
    return isValid;
}

function validateAllInputs() {
    let isValid = true;
    document.querySelectorAll('input[type="number"]').forEach(input => {
        if (!validateInput(input)) isValid = false;
    });
    return isValid;
}

function initValidation() {
    document.querySelectorAll('input[type="number"]').forEach(input => {
        input.addEventListener('input', () => validateInput(input));
        validateInput(input);
    });
}

// ===== UI Update Functions =====
function updateProfitOptionClasses() {
    const customMarkupOption = $('customMarkupOption');
    const optimizeCostOption = $('optimizeCostOption');
    const residualOption = $('residualOption');
    
    // Reset classes first
    customMarkupOption.classList.remove('active', 'disabled');
    optimizeCostOption.classList.remove('active', 'disabled');
    residualOption.classList.remove('active');
    
    // Update based on state
    if (state.options.enableAutoCostOptimization) {
        optimizeCostOption.classList.add('active');
        customMarkupOption.classList.add('disabled');
    } else if (state.options.useCustomMarkup) {
        customMarkupOption.classList.add('active');
    }
    
    if (state.options.enableResidualPercentage) {
        residualOption.classList.add('active');
    }
}

function updatePercentageDisplays() {
    const percentageFields = ['regularSupplies', 'additionalEquipment', 'uniformSafety', 'communications', 'overhead'];
    percentageFields.forEach(field => {
        const percentage = state.options[field + 'Percentage'];
        document.querySelectorAll(`#${field}PercDisplay, #${field}PercDisplay2`).forEach(el => {
            if (el) el.textContent = percentage;
        });
    });
}

function updateHoodPriceLabels() {
    setContent('largeHoodPrice', `$${state.config.largeHoodPrice} each`);
    setContent('smallHoodPrice', `$${state.config.smallHoodPrice} each`);
}

function updateInsuranceDetails() {
    setContent('workCompDetails', `$${state.config.workCompRate} per $100 of labor cost`);
    setContent('generalLiabilityDetails', `$${state.config.glRate} per $1,000 of total price`);
}

function updateCommissionSplitInputs() {
    const splitsWrapper = $('commissionSplitsWrapper');
    const splitRows = $('splitCommissionRowsContent');
    
    // Clear existing inputs and rows
    splitsWrapper.innerHTML = '';
    splitRows.innerHTML = '';
    
    // Create input for each split
    state.options.commissionSplits.forEach((percentage, index) => {
        // Create input field
        const inputContainer = document.createElement('div');
        inputContainer.className = 'percentage-option';
        inputContainer.style.marginBottom = '8px';
        inputContainer.innerHTML = `
            <label for="commissionSplit${index+1}">Commission ${index+1}</label>
            <input type="number" id="commissionSplit${index+1}" min="0" max="100" step="0.1" value="${percentage}" class="commission-split-input">
        `;
        
        // Add delete button if more than 2 splits
        if (state.options.commissionSplits.length > 2) {
            const deleteBtn = document.createElement('button');
            deleteBtn.innerHTML = '<i class="fas fa-times"></i>';
            deleteBtn.style.marginLeft = '5px';
            deleteBtn.style.background = '#e74c3c';
            deleteBtn.style.color = 'white';
            deleteBtn.style.border = 'none';
            deleteBtn.style.borderRadius = '4px';
            deleteBtn.style.padding = '3px 6px';
            deleteBtn.style.cursor = 'pointer';
            deleteBtn.dataset.index = index;
            deleteBtn.addEventListener('click', function() {
                const idx = parseInt(this.dataset.index);
                state.options.commissionSplits.splice(idx, 1);
                updateCommissionSplitInputs();
                calculateAll();
            });
            inputContainer.appendChild(deleteBtn);
        }
        
        splitsWrapper.appendChild(inputContainer);
        
        // Create result row
        const resultRow = document.createElement('div');
        resultRow.className = 'profit-row commission-split-row';
        resultRow.dataset.index = index + 1;
        resultRow.innerHTML = `
            <div class="label">Commission ${index+1} (<span class="commission-split-display">${percentage}</span>%):</div>
            <div class="value commission-split-value">$0.00</div>
        `;
        splitRows.appendChild(resultRow);
    });
    
    // Update totals
    updateCommissionSplitTotals();
}

function updateCommissionSplitTotals() {
    const totalPercentage = state.options.commissionSplits.reduce((sum, val) => sum + val, 0);
    setContent('totalCommissionSplit', totalPercentage + '%');
    setContent('totalCommissionSplitDisplay', totalPercentage);
}

function updateCommissionSplitDisplay(splitCommissions) {
    splitCommissions.forEach((commission, index) => {
        const rows = document.querySelectorAll('.commission-split-row');
        if (index < rows.length) {
            const percentageDisplay = rows[index].querySelector('.commission-split-display');
            const valueDisplay = rows[index].querySelector('.commission-split-value');
            
            if (percentageDisplay) percentageDisplay.textContent = commission.percentage;
            if (valueDisplay) valueDisplay.textContent = formatCurrency(commission.amount);
        }
    });
}

// ===== Tab and Section Management =====
function toggleSection(sectionId, button) {
    const section = $(sectionId);
    const icon = button.querySelector('i');
    
    if (section.classList.contains('hidden-section')) {
        section.classList.remove('hidden-section');
        icon.className = 'fas fa-chevron-up';
        state.ui.sectionStates[sectionId] = 'open';
    } else {
        section.classList.add('hidden-section');
        icon.className = 'fas fa-chevron-down';
        state.ui.sectionStates[sectionId] = 'closed';
    }
}

function showContent(contentId) {
    // Hide all content sections
    document.querySelectorAll('.calculator-content').forEach(section => {
        section.style.display = 'none';
        section.setAttribute('aria-hidden', 'true');
    });
    
    // Show requested section
    $(contentId).style.display = 'block';
    $(contentId).setAttribute('aria-hidden', 'false');
    
    // Update tab selection
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.remove('active');
        tab.setAttribute('aria-selected', 'false');
    });
    
    // Set active tab
    let tabId;
    switch (contentId) {
        case 'quotationContent': tabId = 'quotationTab'; break;
        case 'configContent': tabId = 'configTab'; break;
        default: tabId = 'quotationTab';
    }
    
    $(tabId).classList.add('active');
    $(tabId).setAttribute('aria-selected', 'true');
}

function resetCalculator() {
    if (!confirm('Are you sure you want to reset the calculator? All current data will be lost.')) return;
    //hola
    // Save UI state and config
    const uiSectionStates = state.ui.sectionStates;
    const savedConfig = { ...state.config };
    
    // Reset state to defaults but keep saved config
    Object.assign(state, {
        useSubcontractor: false,
        subcontractorCost: 0,
        workers: 2,
        hours: 4,
        days: 1,
        materialsPerDay: 50,
        equipmentPerDay: 40,
        largeHoods: 0,
        smallHoods: 0,
        hoodCleaningFrequency: 1,
        hoodLaborCostPerc: 38,
        hoodMaterialCostPerc: 12,
        isHoliday: false,
        outsideHouston: false,
        includeInsurance: true,
        config: savedConfig,
        options: {
            includeTransport: true,
            includeMaterials: true,
            includeEquipment: true,
            enableRounding: true,
            roundingMethod: 'up',
            roundingValue: 50,
            useCustomMarkup: false,
            customMarkupPercentage: 120,
            commissionPercentage: 20,
            enableCommissionSplit: false,
            commissionSplits: [10, 10],
            regularSuppliesPercentage: 6,
            additionalEquipmentPercentage: 2.75,
            uniformSafetyPercentage: 2.5,
            communicationsPercentage: 1,
            overheadPercentage: 5,
            enableInitialFee: false,
            initialFeeValue: 150,
            enableResidualPercentage: false,
            residualPercentageValue: 10,
            enableAutoCostOptimization: false
        },
        ui: {
            sectionStates: uiSectionStates,
            operationalCostsExpanded: false
        }
    });
    
    updateUIFromState();
    calculateAll();
    showContent('quotationContent');
    alert('Calculator has been reset successfully.');
}

// ===== Update UI From State =====
function updateUIFromState() {
    // Basic fields
    $('useSubcontractor').checked = state.useSubcontractor;
    $('subcontractorDetails').classList.toggle('visible', state.useSubcontractor);
    $('subcontractorCost').value = state.subcontractorCost;
    $('workers').value = state.workers;
    $('hours').value = state.hours;
    $('days').value = state.days;
    $('materials').value = state.materialsPerDay;
    $('equipment').value = state.equipmentPerDay;
    $('isHoliday').checked = state.isHoliday;
    $('outsideHouston').checked = state.outsideHouston;
    $('includeInsurance').checked = state.includeInsurance;
    
    // Hood cleaning
    $('largeHoods').value = state.largeHoods;
    $('smallHoods').value = state.smallHoods;
    $('hoodFrequency').value = state.hoodCleaningFrequency;
    $('hoodLaborCostPerc').value = state.hoodLaborCostPerc;
    $('hoodMaterialCostPerc').value = state.hoodMaterialCostPerc;
    
    // Config values
    $('regularPayRate').value = state.config.regularPayRate;
    $('supervisorPayRate').value = state.config.supervisorPayRate;
    $('transportCostConfig').value = state.config.transportCostPerDay;
    $('outsideHoustonTransportConfig').value = state.config.outsideHoustonTransportCostPerDay;
    $('largeHoodPriceConfig').value = state.config.largeHoodPrice;
    $('smallHoodPriceConfig').value = state.config.smallHoodPrice;
    $('workCompRate').value = state.config.workCompRate;
    $('glRate').value = state.config.glRate;
    
    // Update display values
    updateHoodPriceLabels();
    updateInsuranceDetails();
    
    // Option checkboxes
    $('includeTransport').checked = state.options.includeTransport;
    $('includeMaterials').checked = state.options.includeMaterials;
    $('includeEquipment').checked = state.options.includeEquipment;
    $('enableAutoCostOptimization').checked = state.options.enableAutoCostOptimization;
    $('enableRounding').checked = state.options.enableRounding;
    $('enableCommissionSplit').checked = state.options.enableCommissionSplit;
    $('useCustomMarkup').checked = state.options.useCustomMarkup;
    $('enableInitialFee').checked = state.options.enableInitialFee;
    $('enableResidualPercentage').checked = state.options.enableResidualPercentage;
    
    // Toggle containers based on options
    $('splitCommissionContainer').style.display = state.options.enableCommissionSplit ? 'block' : 'none';
    $('salesCommissionRow').style.display = state.options.enableCommissionSplit ? 'none' : 'grid';
    $('splitCommissionRows').style.display = state.options.enableCommissionSplit ? 'block' : 'none';
    $('markupSliderContainer').style.display = state.options.useCustomMarkup ? 'block' : 'none';
    $('initialFeeContainer').style.display = state.options.enableInitialFee ? 'block' : 'none';
    $('residualPercentageContainer').style.display = state.options.enableResidualPercentage ? 'block' : 'none';
    
    // Update profit option visuals
    updateProfitOptionClasses();
    
    // Update slider and numeric inputs
    $('markupSlider').value = state.options.customMarkupPercentage;
    $('markupInput').value = state.options.customMarkupPercentage;
    $('initialFeeValue').value = state.options.initialFeeValue;
    $('residualPercentageValue').value = state.options.residualPercentageValue;
    $('residualPercentageDisplay').textContent = state.options.residualPercentageValue;
    $('regularSuppliesPercentage').value = state.options.regularSuppliesPercentage;
    $('additionalEquipmentPercentage').value = state.options.additionalEquipmentPercentage;
    $('uniformSafetyPercentage').value = state.options.uniformSafetyPercentage;
    $('communicationsPercentage').value = state.options.communicationsPercentage;
    $('overheadPercentage').value = state.options.overheadPercentage;
    $('commissionPercentage').value = state.options.commissionPercentage;
    $('commissionPercentageDisplay').textContent = state.options.commissionPercentage;
    
    // Update commission split inputs
    updateCommissionSplitInputs();
    
    // Update percentage displays
    updatePercentageDisplays();
}

function updateUIForSubcontractor(isSubcontractor, internalCost, subcontractorCost, extraBenefit) {
    if (isSubcontractor) {
        // Cross out internal costs since they're not what we'll actually pay
        document.querySelectorAll('#laborCost, #laborTax, #workCompCost, #transportCost, #materialsCost, #equipmentCost, #hoodCleaningCost')
            .forEach(el => el.classList.add('text-crossed'));
        
        // Explain they are reference costs for final price calculation
        const costsText = 'Costo de referencia usado para calcular el precio final';
        setHTML('laborDetails', costsText);
        setHTML('laborTaxDetails', costsText);
        setHTML('workCompDetails', costsText);
        setHTML('transportDetails', costsText);
        setHTML('materialsDetails', costsText);
        setHTML('equipmentDetails', costsText);
        setHTML('hoodCleaningDetails', costsText);
        
        // Show subcontractor cost and additional benefit
        setContent('subcontractorCostDisplay', formatCurrency(subcontractorCost));
        setContent('extraBenefitValue', formatCurrency(extraBenefit));
        toggleClass('extraBenefitValue', 'text-highlight', extraBenefit > 0);
        
        // Show clearer text about savings
        setDisplay('extraBenefitRow', true);
        setHTML('extraBenefitRow', 'Ahorro por usar subcontratista en lugar de equipo interno (diferencia entre costos internos y costo del subcontratista)');
        
        // Also show these savings in profit breakdown section
        setDisplay('subcontractorSavingRow', true);
    } else {
        // If not using a subcontractor, remove any cross-out styling
        document.querySelectorAll('#laborCost, #laborTax, #workCompCost, #transportCost, #materialsCost, #equipmentCost, #hoodCleaningCost')
            .forEach(el => el.classList.remove('text-crossed'));
        
        // Generate labor details text
        let laborDetails = '';
        if (state.workers > 0) {
            if (state.days === 1 && state.workers > 1) {
                laborDetails = `${state.workers-1} workers at ${formatCurrency(state.config.regularPayRate)}/hr × ${state.hours} hrs<br>` +
                            `1 supervisor at ${formatCurrency(state.config.supervisorPayRate)}/hr × ${state.hours} hrs`;
            } else if (state.workers > 0) {
                laborDetails = `${state.workers} workers at ${formatCurrency(state.config.regularPayRate)}/hr × ${state.hours} hrs × ${state.days} days`;
            }
            
            // Add hood labor costs if there are any hoods
            if (state.largeHoods > 0 || state.smallHoods > 0) {
                laborDetails += `<br>Plus hood cleaning labor costs`;
            }
        } else if (state.largeHoods > 0 || state.smallHoods > 0) {
            laborDetails = `Labor costs for hood cleaning only`;
        }
        
        // Set details for each row
        setHTML('laborDetails', laborDetails);
        setHTML('laborTaxDetails', "17% mandatory employment taxes on labor");
        setHTML('workCompDetails', `$${state.config.workCompRate} per $100 of labor cost`);
        
        // Transport details based on location
        let transportDetails = '';
        if (state.options.includeTransport) {
            const transportRate = state.outsideHouston ? 
                formatCurrency(state.config.outsideHoustonTransportCostPerDay) : 
                formatCurrency(state.config.transportCostPerDay);
            
            transportDetails = `${transportRate} per day × ${state.days} days`;
            
            if (state.days > 7) {
                transportDetails += " (with long-term contract discount)";
            }
            
            if (state.outsideHouston) {
                transportDetails += " - Outside Houston rate";
            }
        } else {
            transportDetails = "Transport cost excluded";
        }
        setHTML('transportDetails', transportDetails);
        
        // Materials and equipment details
        let materialsDetails = "";
        if (state.options.includeMaterials) {
            materialsDetails = `${formatCurrency(state.materialsPerDay)} per day × ${state.days} days`;
            
            // Add hood materials if there are any hoods
            if (state.largeHoods > 0 || state.smallHoods > 0) {
                materialsDetails += `<br>Plus materials for hood cleaning`;
            }
        } else {
            materialsDetails = "Materials cost excluded";
        }
        setHTML('materialsDetails', materialsDetails);
            
        setHTML('equipmentDetails', state.options.includeEquipment ? 
            `${formatCurrency(state.equipmentPerDay)} per day × ${state.days} days` : 
            "Equipment cost excluded");
    
        // Hood cleaning details
        let hoodDetails = '';
        if (state.largeHoods > 0) {
            hoodDetails += `${state.largeHoods} large hoods at $${state.config.largeHoodPrice} each<br>`;
        }
        if (state.smallHoods > 0) {
            hoodDetails += `${state.smallHoods} small hoods at $${state.config.smallHoodPrice} each<br>`;
        }
        if (state.hoodCleaningFrequency > 1) {
            hoodDetails += `Frequency: ${state.hoodCleaningFrequency} times (with discount)`;
        }
        
        if (state.largeHoods > 0 || state.smallHoods > 0) {
            hoodDetails += `<br>Labor: ${state.hoodLaborCostPerc}%, Materials: ${state.hoodMaterialCostPerc}% of price`;
        }
        
        setHTML('hoodCleaningDetails', hoodDetails);
        
        // Hide subcontractor-related rows
        setDisplay('extraBenefitRow', false);
        setDisplay('subcontractorSavingRow', false);
    }
}

// ===== Calculation Engine =====
function calculateAll() {
    if (!validateAllInputs()) return;
    
    try {
        const { 
            useSubcontractor, subcontractorCost, workers, hours, days, materialsPerDay, 
            equipmentPerDay, largeHoods, smallHoods, hoodCleaningFrequency,
            hoodLaborCostPerc, hoodMaterialCostPerc, isHoliday, outsideHouston, includeInsurance, 
            config, options 
        } = state;
        
        // Calculate hood cleaning costs first
        let hoodCleaningCost = 0, showHoodCleaning = false;
        let hoodLaborCost = 0, hoodMaterialCost = 0;
        
        if (largeHoods > 0 || smallHoods > 0) {
            hoodCleaningCost = ((largeHoods * config.largeHoodPrice) + 
                               (smallHoods * config.smallHoodPrice)) * hoodCleaningFrequency;
            
            // Apply quantity discount
            if (hoodCleaningFrequency > 1) {
                hoodCleaningCost *= (0.9 - (Math.min(5, hoodCleaningFrequency) - 1) * 0.05);
            }
            
            // Calculate hood labor and material costs
            hoodLaborCost = hoodCleaningCost * (hoodLaborCostPerc / 100);
            hoodMaterialCost = hoodCleaningCost * (hoodMaterialCostPerc / 100);
            
            showHoodCleaning = true;
        }
        
        // Regular labor cost calculation
        let supervisors = 0, regularWorkers = workers;
        let regularLaborCost = 0;
        
        if (workers > 0) {
            if (days === 1 && workers > 1) {
                supervisors = 1;
                regularWorkers = workers - 1;
            }
            
            regularLaborCost = (regularWorkers * config.regularPayRate * hours * days) + 
                            (supervisors * config.supervisorPayRate * hours * days);
        }
        
        // Total labor cost (regular labor + hood labor)
        const laborCost = regularLaborCost + hoodLaborCost;
        const laborTax = laborCost * 0.17; // 17% tax on labor costs
        
        // Worker's Compensation
        const workCompCost = includeInsurance ? (laborCost * config.workCompRate / 100) : 0;
        
        // Transport cost calculation
        let transportCost = 0;
        if (options.includeTransport) {
            // Choose appropriate transport cost based on location
            const dailyTransportCost = outsideHouston ? 
                config.outsideHoustonTransportCostPerDay : config.transportCostPerDay;
            transportCost = dailyTransportCost * days;
            
            // Apply discounts for longer contracts
            if (days > 7) transportCost *= 0.8;
            if (days > 21) transportCost *= 0.7;
        }
        
        // Materials and equipment (regular + hood materials)
        const materialsCost = options.includeMaterials ? (materialsPerDay * days) + hoodMaterialCost : hoodMaterialCost;
        const equipmentCost = options.includeEquipment ? equipmentPerDay * days : 0;
        
        // Base costs sum
        const baseCosts = laborCost + laborTax + workCompCost + transportCost + 
                         materialsCost + equipmentCost + hoodCleaningCost;
        
        // Operational costs calculation
        const regularSuppliesCost = baseCosts * (options.regularSuppliesPercentage / 100);
        const additionalEquipmentCost = baseCosts * (options.additionalEquipmentPercentage / 100);
        const uniformSafetyCost = baseCosts * (options.uniformSafetyPercentage / 100);
        const communicationsCost = baseCosts * (options.communicationsPercentage / 100);
        const overheadCost = baseCosts * (options.overheadPercentage / 100);
        
        // Total operational costs
        const operationalCosts = regularSuppliesCost + additionalEquipmentCost + 
                               uniformSafetyCost + communicationsCost + overheadCost;
        
        // Subtotal
        const internalCostSubtotal = baseCosts + operationalCosts;
        const directCosts = internalCostSubtotal;
        const subtotal = internalCostSubtotal;
        
        // Apply residual percentage
        let residualPercentageAmount = 0;
        let adjustedSubtotal = subtotal;
        
        if (options.enableResidualPercentage) {
            residualPercentageAmount = subtotal * (options.residualPercentageValue / 100);
            adjustedSubtotal += residualPercentageAmount;
        }
        
        // Calculate markup percentage
        let markupPercentage = calculateMarkupPercentage(days);
        
        // Target cost percentage optimization
        const targetCostPercentage = 62;
        let isOptimizationActive = false;
        
        if (options.enableAutoCostOptimization) {
            isOptimizationActive = true;
            markupPercentage = Math.round(((directCosts * 100 / targetCostPercentage) / adjustedSubtotal - 1) * 100);
            markupPercentage = Math.max(20, markupPercentage);
        }
        
        // Apply markup
        const markup = adjustedSubtotal * (markupPercentage / 100);
        
        // Holiday surcharge
        const totalBeforeHoliday = adjustedSubtotal + markup;
        const holidaySurcharge = isHoliday ? totalBeforeHoliday * 0.25 : 0;
        
        // Total Price (before any rounding, initial fee, or insurance)
        let totalPrice = totalBeforeHoliday + holidaySurcharge;
        
        // Calculate General Liability Insurance
        const generalLiabilityCost = includeInsurance ? (totalPrice * config.glRate / 1000) : 0;
        
        // Initial Fee
        let initialFeeAmount = options.enableInitialFee ? options.initialFeeValue : 0;
        
        // Calculate grand total with rounding
        let preRoundingTotal = totalPrice + generalLiabilityCost + initialFeeAmount;
        let roundingAdjustment = 0;
        let grandTotal = preRoundingTotal;
        
        if (options.enableRounding) {
            const roundedTotal = roundAmount(preRoundingTotal, 'up', 50);
            roundingAdjustment = roundedTotal - preRoundingTotal;
            grandTotal = roundedTotal;
        }
        
        // Calculate cost and profit percentages
        let totalCostPercentage = 0;
        let extraBenefit = 0;
        
        if (useSubcontractor) {
            totalCostPercentage = Math.round((subcontractorCost / totalPrice) * 100);
            extraBenefit = internalCostSubtotal - subcontractorCost;
        } else {
            totalCostPercentage = Math.round((directCosts / totalPrice) * 100);
        }
        
        const totalProfitPercentage = 100 - totalCostPercentage;
        const isTargetAchieved = (totalCostPercentage === targetCostPercentage);
        
        // Net profit calculation
        let netProfit = 0;
        if (useSubcontractor) {
            netProfit = grandTotal - subcontractorCost;
        } else {
            netProfit = grandTotal - directCosts;
        }
        
        // Sales commission calculation
        let salesCommission = 0;
        let splitCommissions = [];
        
        if (options.enableCommissionSplit) {
            // Calculate each split commission
            let totalCommissionPercentage = 0;
            splitCommissions = options.commissionSplits.map(percentage => {
                totalCommissionPercentage += percentage;
                const commissionAmount = netProfit * (percentage / 100);
                return { percentage, amount: commissionAmount };
            });
            
            // Total commission amount
            salesCommission = netProfit * (totalCommissionPercentage / 100);
        } else {
            // Standard commission
            salesCommission = netProfit * (options.commissionPercentage / 100);
        }
        
        // Final profit
        const finalCompanyProfit = netProfit - salesCommission;
        
        // Update UI based on calculations
        updateUIForSubcontractor(useSubcontractor, internalCostSubtotal, subcontractorCost, extraBenefit);
        
        // Show/hide rows based on conditions
        setDisplay('holidayRow', isHoliday);
        setDisplay('hoodCleaningRow', showHoodCleaning);
        setDisplay('roundingRow', options.enableRounding);
        setDisplay('initialFeeRow', options.enableInitialFee);
        setDisplay('residualPercentageRow', options.enableResidualPercentage);
        setDisplay('workCompRow', includeInsurance);
        setDisplay('generalLiabilityRow', includeInsurance);
        setDisplay('grandTotalRow', true); // Always show
        setDisplay('salesCommissionRow', !options.enableCommissionSplit);
        setDisplay('splitCommissionRows', options.enableCommissionSplit);
        
        // Update split commission displays
        if (options.enableCommissionSplit) {
            updateCommissionSplitDisplay(splitCommissions);
            const totalSplitPercent = options.commissionSplits.reduce((sum, value) => sum + value, 0);
            setContent('totalCommissionSplitDisplay', totalSplitPercent);
            setContent('totalSplitCommission', formatCurrency(salesCommission));
        }
        
        // Show/hide optimization indicators
        setDisplay('optimizationBadge', isOptimizationActive);
        setDisplay('targetAchievedBadge', isTargetAchieved);
        
        // Update operational costs display
        setContent('operationalCostsValue', formatCurrency(operationalCosts));
        setContent('regularSuppliesValue', formatCurrency(regularSuppliesCost));
        setContent('additionalEquipmentValue', formatCurrency(additionalEquipmentCost));
        setContent('uniformSafetyValue', formatCurrency(uniformSafetyCost));
        setContent('communicationsValue', formatCurrency(communicationsCost));
        setContent('overheadValue', formatCurrency(overheadCost));
        
        if (options.enableInitialFee) {
            setContent('initialFeeAmount', formatCurrency(initialFeeAmount));
        }
        
        if (options.enableResidualPercentage) {
            setContent('residualPercentageDisplay', options.residualPercentageValue);
            setContent('residualPercentageAmount', formatCurrency(residualPercentageAmount));
        }
        
        // Display rounding details
        if (options.enableRounding) {
            setHTML('roundingDetails', 'Rounding Grand Total up to the next $50');
        }
        
        // Subcontractor UI updates
        setDisplay('subcontractorRow', useSubcontractor);
        setDisplay('extraBenefitRow', useSubcontractor);
        
        // Operational costs details display
        setDisplay('operationalCostsDetails', $('operationalCostsRow').classList.contains('expanded'));
        setDisplay('regularSuppliesRow', !useSubcontractor, 'flex');
        setDisplay('additionalEquipmentRow', !useSubcontractor, 'flex');
        setDisplay('uniformSafetyRow', !useSubcontractor, 'flex');
        
        // Cost percentage display
        setContent('totalCostPercentage', `${totalCostPercentage}%`);
        setContent('totalProfitPercentage', `${totalProfitPercentage}%`);
        $('costPercentageFill').style.width = `${totalCostPercentage}%`;
        $('costPercentageFill').setAttribute('aria-valuenow', totalCostPercentage);
        setContent('percentageTextOverlay', `${totalCostPercentage}%`);
        
        // Update total and grand total
        setContent('totalPrice', formatCurrency(totalPrice));
        setContent('generalLiabilityCost', formatCurrency(generalLiabilityCost));
        setContent('workCompCost', formatCurrency(workCompCost));
        setContent('roundingAdjustment', formatCurrency(roundingAdjustment));
        setContent('grandTotal', formatCurrency(grandTotal));
        
        // Set color of cost percentage bar based on value
        if (totalCostPercentage > 75) {
            $('costPercentageFill').style.backgroundColor = '#e74c3c';
            $('finalCompanyProfit').classList.add('low-profit');
            $('finalCompanyProfit').classList.remove('high-profit');
        } else if (totalCostPercentage > 65) {
            $('costPercentageFill').style.backgroundColor = '#f39c12';
            $('finalCompanyProfit').classList.remove('low-profit');
            $('finalCompanyProfit').classList.remove('high-profit');
        } else {
            $('costPercentageFill').style.backgroundColor = '#27ae60';
            $('finalCompanyProfit').classList.remove('low-profit');
            $('finalCompanyProfit').classList.add('high-profit');
        }
        
        // Special coloring for 62% target
        if (isTargetAchieved) {
            $('costPercentageFill').style.backgroundColor = 'var(--optimize-color)';
        }
        
        // Update results display
        updateResults({
            laborCost, laborTax, workCompCost, transportCost, materialsCost, equipmentCost,
            hoodCleaningCost, subcontractorCost, extraBenefit,
            regularSuppliesCost, additionalEquipmentCost, uniformSafetyCost, communicationsCost, overheadCost,
            subtotal, markup, markupPercentage, holidaySurcharge, roundingAdjustment, initialFeeAmount, generalLiabilityCost,
            residualPercentageAmount, totalPrice, grandTotal, netProfit, salesCommission, finalCompanyProfit,
            isOptimizationActive, splitCommissions
        });
    } catch (error) {
        console.error("Calculation error:", error);
        alert("There was an error during calculation. Please check your inputs.");
    }
}

// Update results display
function updateResults(results) {
    // Update currency values
    const resultElements = {
        'laborCost': results.laborCost,
        'laborTax': results.laborTax,
        'workCompCost': results.workCompCost,
        'transportCost': results.transportCost,
        'materialsCost': results.materialsCost,
        'equipmentCost': results.equipmentCost,
        'hoodCleaningCost': results.hoodCleaningCost,
        'subtotal': results.subtotal,
        'markup': results.markup,
        'holidaySurcharge': results.holidaySurcharge,
        'roundingAdjustment': results.roundingAdjustment,
        'initialFeeAmount': results.initialFeeAmount,
        'generalLiabilityCost': results.generalLiabilityCost,
        'netProfit': results.netProfit,
        'salesCommission': results.salesCommission,
        'finalCompanyProfit': results.finalCompanyProfit,
        'profitMarkup': results.markup
    };
    
    // Update all currency elements
    Object.entries(resultElements).forEach(([id, value]) => {
        setContent(id, formatCurrency(value));
    });
    
    // Update percentage displays
    setContent('markupPercentage', results.markupPercentage);
    setContent('profitMarkupPercentage', results.markupPercentage);
    
    // Set markup details text based on option
    let markupDetailsText = '';
    if (results.isOptimizationActive) {
        markupDetailsText = 'Automatically optimized for 62% cost ratio';
        $('markupRow').classList.add('optimization-active');
    } else if (state.options.useCustomMarkup) {
        markupDetailsText = 'Using custom markup percentage';
        $('markupRow').classList.remove('optimization-active');
    } else {
        markupDetailsText = `Calculated based on contract length of ${state.days} days`;
        $('markupRow').classList.remove('optimization-active');
    }
    setHTML('markupDetails', markupDetailsText);
    
    // Update split commission display if applicable
    if (state.options.enableCommissionSplit && results.splitCommissions) {
        updateCommissionSplitDisplay(results.splitCommissions);
    }
}

// Screenshot function
function captureScreenshot() {
    try {
        alert('Screenshot functionality would require the html2canvas library. For now, use the Print function which will work just as well for capturing the quote.');
    } catch (error) {
        console.error('Screenshot error:', error);
        alert('There was an error creating the screenshot. Please try using the print function instead.');
    }
}

// Initialize calculator on page load
document.addEventListener('DOMContentLoaded', () => {
    initEventListeners();
    initValidation();
    updateHoodPriceLabels();
    calculateAll();
});
</script>
</body>
</html>